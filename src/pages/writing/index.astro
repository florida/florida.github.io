---
import Layout from "../../layouts/Layout.astro";
import { ghostClient } from "../../lib/ghost";
import { formatDate } from "../../lib/format_date";

const posts = await ghostClient.posts.browse({
	filter: 'tag:writing',
	include: 'authors',
	limit: 'all'
})

// Group posts by year
const postsByYear = posts.reduce((acc, post) => {
	const year = new Date(post.published_at).getFullYear();
	if (!acc[year]) {
		acc[year] = [];
	}
	acc[year].push(post);
	return acc;
}, {} as Record<number, typeof posts>);

// Sort years in descending order
const sortedYears = Object.keys(postsByYear)
	.map(Number)
	.sort((a, b) => b - a);
---

<Layout title="Writing">
  <main>
    <section class="outlined-full-width">
      {sortedYears.map((year) => (
        <div class="year-section">
          <div class="year-heading">
            <h2>{year}</h2>
          </div>
          <article class="writing-table">
            {postsByYear[year].map((post) => (
              <a href={`/writing/${post.slug}`} class="writing-row">
                <div class="writing-date">
                  <time datetime={post.published_at}>
                    {formatDate(post.published_at)}
                  </time>
                </div>
                <div class="writing-title">
                  {post.title}
                </div>
              </a>
            ))}
          </article>
        </div>
      ))}
    </section>
  </main>
</Layout>

<style>
  section.outlined-full-width {
    border-bottom: 0 !important;
  }

  @keyframes cycleHue {
    0% { background-color: #e8f4f8; }
    12.5% { background-color: #fef0f5; }
    25% { background-color: #f5f0e8; }
    37.5% { background-color: #f0f8e8; }
    50% { background-color: #fff5e8; }
    62.5% { background-color: #e8f0f8; }
    75% { background-color: #f8e8f0; }
    87.5% { background-color: #e8f8f0; }
    100% { background-color: #fff8e8; }
  }

  @keyframes cycleHue1 {
    0% { background-color: #fef0f5; }
    12.5% { background-color: #f5f0e8; }
    25% { background-color: #f0f8e8; }
    37.5% { background-color: #fff5e8; }
    50% { background-color: #e8f0f8; }
    62.5% { background-color: #f8e8f0; }
    75% { background-color: #e8f8f0; }
    87.5% { background-color: #fff8e8; }
    100% { background-color: #e8f4f8; }
  }

  @keyframes cycleHue2 {
    0% { background-color: #f5f0e8; }
    12.5% { background-color: #f0f8e8; }
    25% { background-color: #fff5e8; }
    37.5% { background-color: #e8f0f8; }
    50% { background-color: #f8e8f0; }
    62.5% { background-color: #e8f8f0; }
    75% { background-color: #fff8e8; }
    87.5% { background-color: #e8f4f8; }
    100% { background-color: #fef0f5; }
  }

  @keyframes cycleHue3 {
    0% { background-color: #f0f8e8; }
    12.5% { background-color: #fff5e8; }
    25% { background-color: #e8f0f8; }
    37.5% { background-color: #f8e8f0; }
    50% { background-color: #e8f8f0; }
    62.5% { background-color: #fff8e8; }
    75% { background-color: #e8f4f8; }
    87.5% { background-color: #fef0f5; }
    100% { background-color: #f5f0e8; }
  }

  @keyframes cycleHue4 {
    0% { background-color: #fff5e8; }
    12.5% { background-color: #e8f0f8; }
    25% { background-color: #f8e8f0; }
    37.5% { background-color: #e8f8f0; }
    50% { background-color: #fff8e8; }
    62.5% { background-color: #e8f4f8; }
    75% { background-color: #fef0f5; }
    87.5% { background-color: #f5f0e8; }
    100% { background-color: #f0f8e8; }
  }

  @keyframes cycleHue5 {
    0% { background-color: #e8f0f8; }
    12.5% { background-color: #f8e8f0; }
    25% { background-color: #e8f8f0; }
    37.5% { background-color: #fff8e8; }
    50% { background-color: #e8f4f8; }
    62.5% { background-color: #fef0f5; }
    75% { background-color: #f5f0e8; }
    87.5% { background-color: #f0f8e8; }
    100% { background-color: #fff5e8; }
  }

  @keyframes cycleHue6 {
    0% { background-color: #f8e8f0; }
    12.5% { background-color: #e8f8f0; }
    25% { background-color: #fff8e8; }
    37.5% { background-color: #e8f4f8; }
    50% { background-color: #fef0f5; }
    62.5% { background-color: #f5f0e8; }
    75% { background-color: #f0f8e8; }
    87.5% { background-color: #fff5e8; }
    100% { background-color: #e8f0f8; }
  }

  @keyframes cycleHue7 {
    0% { background-color: #e8f8f0; }
    12.5% { background-color: #fff8e8; }
    25% { background-color: #e8f4f8; }
    37.5% { background-color: #fef0f5; }
    50% { background-color: #f5f0e8; }
    62.5% { background-color: #f0f8e8; }
    75% { background-color: #fff5e8; }
    87.5% { background-color: #e8f0f8; }
    100% { background-color: #f8e8f0; }
  }

  .year-section {
    margin-bottom: 0;
  }

  .year-heading {
    padding: 1rem 2rem;
    border-bottom: 1px solid var(--nc-bg-3);
  }

  .year-heading h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
  }

  .writing-table {
    display: flex;
    flex-direction: column;
  }

  .year-section:not(:first-child) .year-heading {
    border-top: 1px solid var(--nc-bg-3);
  }


  .writing-row {
    display: grid;
    grid-template-columns: 200px 1fr;
    border-bottom: 1px solid var(--nc-bg-3);
    text-decoration: none;
    color: inherit;
    transition: background-color 0.2s ease;
  }

  .writing-row:last-child {
    border-bottom: none;
  }

  .writing-row:hover {
    background-color: var(--nc-bg-2);
  }

  .writing-date {
    padding: 1rem;
    font-family: var(--nc-font-mono);
    font-size: 0.9rem;
    white-space: nowrap;
    border-right: 1px solid var(--nc-bg-3);
    position: relative;
    overflow: hidden;
    isolation: isolate;
    display: flex;
    align-items: center;
  }

  .writing-date::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: -1;
    opacity: 0;
    transition: opacity 0.2s ease 2.5s;
  }

  .writing-date:hover::before {
    opacity: 1;
		animation: var(--hue-animation, cycleHue) 8s ease-in-out infinite;
    transition: opacity 0.1s ease 0s;
  }

  .writing-date:not(:hover)::before {
		animation: var(--hue-animation, cycleHue) 8s ease-in-out infinite;
    transition: opacity 0.2s ease 2.5s;
  }

  .writing-date time {
    color: inherit;
    text-decoration: none;
    position: relative;
    z-index: 1;
  }

  .writing-title {
    padding: 1rem;
    font-weight: 600;
    position: relative;
    overflow: hidden;
    isolation: isolate;
    z-index: 1;
    display: flex;
    align-items: center;
  }

  .writing-title::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: -1;
    opacity: 0;
    transition: opacity 0.2s ease 2.5s;
    animation-delay: var(--hue-delay, 0s);
  }

  .writing-title:hover::before {
    opacity: 1;
		animation: var(--hue-animation, cycleHue) 8s ease-in-out infinite;
    transition: opacity 0.1s ease 0s;
  }

  .writing-title:not(:hover)::before {
		animation: var(--hue-animation, cycleHue) 8s ease-in-out infinite;
    transition: opacity 0.2s ease 2.5s;
  }

  @media (max-width: 768px) {
    .writing-row {
      grid-template-columns: 1fr;
      border-bottom: 1px solid var(--nc-bg-3);
    }

    .writing-date {
      border-right: none;
      border-bottom: 1px solid var(--nc-bg-3);
    }

    .year-heading {
      padding: 1rem;
    }
  }
</style>

<script>
	// Set random animation delays for each hoverable element
	document.addEventListener('DOMContentLoaded', () => {
		// Writing date and title elements
		const writingElements = document.querySelectorAll('.writing-date, .writing-title');
		const animations = ['cycleHue', 'cycleHue1', 'cycleHue2', 'cycleHue3', 'cycleHue4', 'cycleHue5', 'cycleHue6', 'cycleHue7'];
		writingElements.forEach((el) => {
			// Randomly assign one of the 8 animation variations
			const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
			(el as HTMLElement).style.setProperty('--hue-animation', randomAnimation);
		});
	});
</script>
