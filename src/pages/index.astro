---
import Layout from "../layouts/Layout.astro";
import { ghostClient } from '../lib/ghost';
import { formatDate } from '../lib/format_date';
import Terminal from "../components/Terminal.astro";
import { createHash } from '../lib/createHash';

const title ="Home";
const doodle = `:doodle {
  @grid: 10 / 80vmin;
}

background: #000;
transition: @rand(500ms) ease;

border-radius: @pick(
  100% 0 0 0,
  0 100% 0 0,
  0 0 100% 0,
  0 0 0 100%
);`;

const photos = await ghostClient.posts
	.browse({
		filter: 'tag:photo',
		include: 'authors'
	})
	.catch((err) => {
		console.error(err);
	}) || [];

const posts = await ghostClient.posts
    .browse({
        limit: 'all',
		filter: 'tag:writing',
		include: 'authors'
    })
    .catch((err) => {
        console.error(err);
    }) || [];

const hash = await createHash(Astro.url.toString());
---

<Layout title={title}>
	<main>
		<Terminal />
			<section class="outlined-full-width">
			<!-- Swipable CSS carousel with scroll snap -->
			<div class="carousel">
				{photos.map((photo) => (
					<div class="carousel__item">
						<div class="carousel__title">{photo.title}</div>
						<img src={photo.feature_image} alt="">
						<footer>
						<small>
							<time datetime={photo.published_at}>
								{formatDate(photo.published_at)}
							</time> by <a>{photo.authors[0].name}</a>
						</small>
					</footer>
					</div>
				))}
			</div>
		</section>
		<section class="outlined-full-width">	
			<h1>Writing</h1>
			<article class="writing-table">
				{posts.map((post) => (
					<a href={`/writing/${post.slug}`} class="writing-row">
						<div class="writing-left">
							<div class="writing-date">
								<time datetime={post.published_at}>
									{formatDate(post.published_at)}
								</time>
							</div>
							<div class="writing-title">
								{post.title}
							</div>
						</div>
						<div class="writing-content">
							<p class="excerpt">{post.excerpt}</p>
						</div>
					</a>
				))}
			</article>
		</section>
		
		<section class="outlined art">
			<css-doodle class="doodles" click-to-update>{doodle}</css-doodle>
		</section>

		<section class="outlined">
			<h1>Guestbook</h1>

			<div id="cusdis_thread"
				data-host="https://cusdis.com"
				data-app-id="02bf931f-c6ff-4b68-b0ec-d15ae20e3b30"
				data-page-id={hash}
				data-page-url={Astro.url}
				data-page-title={title}
			></div>
		</section>
	</main>
</Layout>
<style>
	.art {
		display: flex;
		align-items: center;
		justify-content: center;
	}
	.doodles {
	}

	.carousel {
		display: flex;
		padding-bottom: 0;
		 
		overflow-x: auto;
		scroll-snap-type: x mandatory;
		scroll-behavior: smooth;
		scrollbar-width: none;
		-webkit-overflow-scrolling: touch;
		gap: 0;
	}

	.carousel__item {
		flex-shrink: 0; 
		width: calc(100% / 4);
		height: 350px;
		scroll-snap-align: start;
		display: flex;
		flex-direction: column;
		position: relative;
		box-sizing: border-box;
	}

	.carousel__item:not(:last-child)::after {
		content: '';
		position: absolute;
		right: 0;
		top: 0;
		bottom: 0;
		width: 1px;
		background: var(--nc-bg-3);
	}

	.carousel__title {
		padding: 0.5rem 1rem;
		font-weight: 600;
		flex-shrink: 0;
		position: relative;
	}

	.carousel__title::after {
		content: '';
		position: absolute;
		left: 0;
		right: 0;
		bottom: 0;
		height: 1px;
		background: var(--nc-bg-3);
	}

	.carousel__item img {
		width: 100%;
		flex: 1;
		object-fit: cover;
		min-height: 0;
	}

	.carousel__item footer {
		flex-shrink: 0;
		padding: 0.5rem 1rem;
		position: relative;
	}

	.carousel__item footer::before {
		content: '';
		position: absolute;
		left: 0;
		right: 0;
		top: 0;
		height: 1px;
		background: var(--nc-bg-3);
	}

	@media (max-width: 1024px) {
		.carousel__item {
			width: calc(100% / 3);
		}
	}

	@media (max-width: 640px) {
		.carousel__item {
			width: 100%;
			height: 500px;
		}
	}
	
	.fleets {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
		gap: 1rem;
	}

	.fleets .retro__window {
		display: flex;
		flex-direction: column;
		height: 100%;
	}

	.fleets .retro__padded-content {
		flex: 1;
		padding: 1rem;
	}

	.writing-table {
		display: flex;
		flex-direction: column;
		border-top: 1px solid var(--nc-bg-3);
		border-bottom: 1px solid var(--nc-bg-3);
	}

	.writing-row {
		display: grid;
		grid-template-columns: 200px 1fr;
		border-bottom: 1px solid var(--nc-bg-3);
		text-decoration: none;
		color: inherit;
		transition: background-color 0.2s ease;
	}

	.writing-row:last-child {
		border-bottom: none;
	}

	.writing-row:hover {
		background-color: var(--nc-bg-2);
	}

	.writing-left {
		display: flex;
		flex-direction: column;
		border-right: 1px solid var(--nc-bg-3);
	}

	@keyframes cycleHue {
		0% { background-color: #e8f4f8; }
		12.5% { background-color: #fef0f5; }
		25% { background-color: #f5f0e8; }
		37.5% { background-color: #f0f8e8; }
		50% { background-color: #fff5e8; }
		62.5% { background-color: #e8f0f8; }
		75% { background-color: #f8e8f0; }
		87.5% { background-color: #e8f8f0; }
		100% { background-color: #fff8e8; }
	}

	@keyframes cycleHue1 {
		0% { background-color: #fef0f5; }
		12.5% { background-color: #f5f0e8; }
		25% { background-color: #f0f8e8; }
		37.5% { background-color: #fff5e8; }
		50% { background-color: #e8f0f8; }
		62.5% { background-color: #f8e8f0; }
		75% { background-color: #e8f8f0; }
		87.5% { background-color: #fff8e8; }
		100% { background-color: #e8f4f8; }
	}

	@keyframes cycleHue2 {
		0% { background-color: #f5f0e8; }
		12.5% { background-color: #f0f8e8; }
		25% { background-color: #fff5e8; }
		37.5% { background-color: #e8f0f8; }
		50% { background-color: #f8e8f0; }
		62.5% { background-color: #e8f8f0; }
		75% { background-color: #fff8e8; }
		87.5% { background-color: #e8f4f8; }
		100% { background-color: #fef0f5; }
	}

	@keyframes cycleHue3 {
		0% { background-color: #f0f8e8; }
		12.5% { background-color: #fff5e8; }
		25% { background-color: #e8f0f8; }
		37.5% { background-color: #f8e8f0; }
		50% { background-color: #e8f8f0; }
		62.5% { background-color: #fff8e8; }
		75% { background-color: #e8f4f8; }
		87.5% { background-color: #fef0f5; }
		100% { background-color: #f5f0e8; }
	}

	@keyframes cycleHue4 {
		0% { background-color: #fff5e8; }
		12.5% { background-color: #e8f0f8; }
		25% { background-color: #f8e8f0; }
		37.5% { background-color: #e8f8f0; }
		50% { background-color: #fff8e8; }
		62.5% { background-color: #e8f4f8; }
		75% { background-color: #fef0f5; }
		87.5% { background-color: #f5f0e8; }
		100% { background-color: #f0f8e8; }
	}

	@keyframes cycleHue5 {
		0% { background-color: #e8f0f8; }
		12.5% { background-color: #f8e8f0; }
		25% { background-color: #e8f8f0; }
		37.5% { background-color: #fff8e8; }
		50% { background-color: #e8f4f8; }
		62.5% { background-color: #fef0f5; }
		75% { background-color: #f5f0e8; }
		87.5% { background-color: #f0f8e8; }
		100% { background-color: #fff5e8; }
	}

	@keyframes cycleHue6 {
		0% { background-color: #f8e8f0; }
		12.5% { background-color: #e8f8f0; }
		25% { background-color: #fff8e8; }
		37.5% { background-color: #e8f4f8; }
		50% { background-color: #fef0f5; }
		62.5% { background-color: #f5f0e8; }
		75% { background-color: #f0f8e8; }
		87.5% { background-color: #fff5e8; }
		100% { background-color: #e8f0f8; }
	}

	@keyframes cycleHue7 {
		0% { background-color: #e8f8f0; }
		12.5% { background-color: #fff8e8; }
		25% { background-color: #e8f4f8; }
		37.5% { background-color: #fef0f5; }
		50% { background-color: #f5f0e8; }
		62.5% { background-color: #f0f8e8; }
		75% { background-color: #fff5e8; }
		87.5% { background-color: #e8f0f8; }
		100% { background-color: #f8e8f0; }
	}

	.writing-date {
		padding: 1rem;
		font-family: var(--nc-font-mono);
		font-size: 0.9rem;
		white-space: nowrap;
		border-bottom: 1px solid var(--nc-bg-3);
		position: relative;
		overflow: hidden;
		isolation: isolate;
		display: flex;
		align-items: center;
	}

	.writing-date::before {
		content: '';
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		z-index: -1;
		opacity: 0;
		transition: opacity 0.2s ease 2.5s;
		animation-delay: var(--hue-delay, 0s);
	}

	.writing-date:hover::before {
		opacity: 1;
		animation: var(--hue-animation, cycleHue) 8s ease-in-out infinite;
		transition: opacity 0.1s ease 0s;
	}

	.writing-date:not(:hover)::before {
		animation: var(--hue-animation, cycleHue) 8s ease-in-out infinite;
		transition: opacity 0.2s ease 2.5s;
	}

	.writing-date time {
		color: inherit;
		text-decoration: none;
		position: relative;
		z-index: 1;
	}

	.writing-title {
		padding: 0.5rem 1rem 1rem 1rem;
		font-weight: 600;
		position: relative;
		overflow: hidden;
		isolation: isolate;
		z-index: 1;
		flex-grow: 1;
	}

	.writing-title::before {
		content: '';
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		z-index: -1;
		opacity: 0;
		transition: opacity 0.2s ease 2.5s;
		animation-delay: var(--hue-delay, 0s);
	}

	.writing-title:hover::before {
		opacity: 1;
		animation: var(--hue-animation, cycleHue) 8s ease-in-out infinite;
		transition: opacity 0.1s ease 0s;
	}

	.writing-title:not(:hover)::before {
		animation: var(--hue-animation, cycleHue) 8s ease-in-out infinite;
		transition: opacity 0.2s ease 2.5s;
	}

	.writing-content {
		padding: 1.5rem 2rem;
		position: relative;
		overflow: hidden;
		isolation: isolate;
	}

	.writing-content::before {
		content: '';
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		z-index: -1;
		opacity: 0;
		transition: opacity 0.2s ease 2.5s;
		animation-delay: var(--hue-delay, 0s);
	}

	.writing-content:hover::before {
		opacity: 1;
		animation: var(--hue-animation, cycleHue) 8s ease-in-out infinite;
		transition: opacity 0.1s ease 0s;
	}

	.writing-content:not(:hover)::before {
		animation: var(--hue-animation, cycleHue) 8s ease-in-out infinite;
		transition: opacity 0.2s ease 2.5s;
	}

	.writing-content .excerpt {
		position: relative;
		z-index: 1;
	}

	.writing-content .excerpt {
		margin: 0;
		line-height: 1.5;
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
		text-overflow: ellipsis;
		color: inherit;
	}

	@media (max-width: 768px) {
		.writing-row {
			grid-template-columns: 1fr;
			border-bottom: 1px solid var(--nc-bg-3);
		}

		.writing-left {
			border-right: none;
			border-bottom: 1px solid var(--nc-bg-3);
		}

		.writing-date {
			padding: 0.75rem 1rem 0.5rem 1rem;
		}

		.writing-title {
			padding: 0.5rem 1rem 0.75rem 1rem;
		}

		.writing-content {
			padding: 0.75rem 1rem;
		}
	}
</style>

<script>
	// Set random animation variations for each hoverable element
	document.addEventListener('DOMContentLoaded', () => {
		// Writing date, title, and content elements
		const writingElements = document.querySelectorAll('.writing-date, .writing-title, .writing-content');
		const animations = ['cycleHue', 'cycleHue1', 'cycleHue2', 'cycleHue3', 'cycleHue4', 'cycleHue5', 'cycleHue6', 'cycleHue7'];
		writingElements.forEach((el) => {
			if (el instanceof HTMLElement) {
				// Randomly assign one of the 8 animation variations
				const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
				el.style.setProperty('--hue-animation', randomAnimation);
			}
		});
	});
</script>
